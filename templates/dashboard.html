<!DOCTYPE html>
<html>
<head>
<title>TIERA</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
margin:0;
font-family:Segoe UI, sans-serif;
display:flex;
background:linear-gradient(135deg,#0a192f,#112240,#1b2a4e);
color:white;
}

/* SIDEBAR */
.sidebar{
width:240px;
height:100vh;
background:linear-gradient(180deg,#0a192f,#112240);
padding-top:30px;
position:fixed;
box-shadow:2px 0 20px rgba(0,0,0,0.5);
}

.sidebar h2{
text-align:center;
margin-bottom:40px;
color:#64b5ff;
}

.sidebar a{
display:block;
padding:14px 25px;
color:#cfd8ff;
text-decoration:none;
transition:0.3s;
cursor:pointer;
}

.sidebar a:hover{
background:#1e3a8a;
color:white;
border-radius:8px;
}

.sidebar a.active{
background:#2563eb;
color:white;
border-radius:8px;
}

/* MAIN */
.main{
margin-left:240px;
padding:30px;
width:100%;
}

/* CARDS */
.card{
background:linear-gradient(135deg,#112240,#1b2a4e);
padding:25px;
margin-bottom:25px;
border-radius:18px;
box-shadow:0 10px 40px rgba(0,0,0,0.4);
transition:0.3s;
}

.card:hover{
transform:translateY(-4px);
box-shadow:0 15px 50px rgba(0,0,0,0.6);
}

/* STATS */
.stats{
display:flex;
gap:25px;
}

.stat-box{
flex:1;
padding:25px;
border-radius:18px;
background:linear-gradient(135deg,#1e3a8a,#2563eb);
text-align:center;
font-size:20px;
font-weight:bold;
box-shadow:0 10px 30px rgba(0,0,0,0.4);
}

/* INPUTS */
input{
padding:12px;
border:none;
border-radius:10px;
margin-right:10px;
background:#1b2a4e;
color:white;
outline:none;
}

input::placeholder{
color:#9bb6ff;
}

button{
padding:12px 20px;
border:none;
border-radius:10px;
background:#2563eb;
color:white;
font-weight:bold;
cursor:pointer;
transition:0.3s;
}

button:hover{
background:#3b82f6;
transform:scale(1.05);
}

/* TABLE */
table{
width:100%;
border-collapse:collapse;
color:white;
}

th{
background:#1e3a8a;
}

th,td{
padding:12px;
border-bottom:1px solid rgba(255,255,255,0.1);
text-align:center;
}

.section{display:none;}
</style>
</head>

<body>

<div class="sidebar">
<h2 style="font-family: Georgia, 'Times New Roman', Times, serif;">TIERA</h2>
<a class="menu active" onclick="showSection('overview',this)">Dashboard</a>
<a class="menu" onclick="showSection('charts',this)">Charts</a>
<a class="menu" onclick="showSection('table',this)">Fraud Table</a>
<a href="/export_pdf">Export PDF</a>
<a href="/logout">Logout</a>
</div>

<div class="main">

<div id="overview" class="section" style="display:block;">
<div class="card">
<h3>Add Transaction</h3>

<!-- FIX 1: supplier type changed to TEXT -->
<input type="text" id="supplier" placeholder="Supplier Name">
<input type="number" id="amount" placeholder="Amount">
<button onclick="analyze()">Analyze</button>

</div>

<div class="stats">
<div class="stat-box">Total<br><span id="totalTx">0</span></div>
<div class="stat-box">Fraud<br><span id="fraudCount">0</span></div>
<div class="stat-box">Avg Risk<br><span id="avgRisk">0</span></div>
</div>
</div>

<div id="charts" class="section">
<div class="card">
<h3>Risk Chart</h3>
<canvas id="barChart"></canvas>
</div>
</div>

<div id="table" class="section">
<div class="card">
<h3>Fraud Records</h3>
<table>
<thead>
<tr><th>Supplier</th><th>Risk</th></tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
</div>

</div>

<script>
let chart;

function showSection(id,element){
document.querySelectorAll('.section').forEach(s=>s.style.display='none');
document.getElementById(id).style.display='block';
document.querySelectorAll('.menu').forEach(m=>m.classList.remove('active'));
if(element) element.classList.add('active');
}

function analyze(){

let supplier=document.getElementById("supplier").value.trim();
let amount=document.getElementById("amount").value;

if(!supplier || !amount){
alert("Please enter Supplier and Amount");
return;
}

fetch("/analyze",{
method:"POST",
headers:{
"Content-Type":"application/x-www-form-urlencoded"
},
body:`supplier=${encodeURIComponent(supplier)}&amount=${amount}`
})
.then(response=>{
if(!response.ok){
throw new Error("Insert failed");
}
return response.text();
})
.then(()=>{
document.getElementById("supplier").value="";
document.getElementById("amount").value="";
loadData();
})
.catch(error=>{
console.error("Error:",error);
alert("Error inserting data. Check server.");
});
}

function loadData(){
fetch("/get_data")
.then(res=>res.json())
.then(data=>{

let suppliers=data.suppliers || [];
let risks=data.risks || [];

document.getElementById("totalTx").innerText=risks.length;
document.getElementById("fraudCount").innerText=risks.filter(r=>r>70).length;
document.getElementById("avgRisk").innerText=
risks.length?(risks.reduce((a,b)=>a+b,0)/risks.length).toFixed(2):0;

let table=document.getElementById("tableBody");
table.innerHTML="";

suppliers.forEach((s,i)=>{
table.innerHTML+=`<tr><td>${s}</td><td>${risks[i]}</td></tr>`;
});

if(chart) chart.destroy();

if(suppliers.length > 0){
let ctx=document.getElementById("barChart").getContext("2d");
chart=new Chart(ctx,{
type:"bar",
data:{
labels:suppliers,
datasets:[{
label:"Risk Score",
data:risks,
backgroundColor:"#3b82f6"
}]
},
options:{
responsive:true,
scales:{
y:{beginAtZero:true,max:100}
}
}
});
}

})
.catch(err=>console.error("Load error:",err));
}

window.onload = function(){
loadData();
};
</script>

</body>
</html>